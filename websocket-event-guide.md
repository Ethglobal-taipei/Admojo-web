# Smart Contract Event-Based Payment Trigger Implementation Guide

## Overview

This guide documents how to implement a payment function trigger in a backend system that responds to event logs generated by a smart contract. The implementation uses Nodit's WebSocket service to monitor blockchain events and trigger appropriate actions in your backend system.

## Architecture

```
[Smart Contract] --emits--> [Event Log] --captured by--> [Nodit WebSocket] --notifies--> [Backend Server] --triggers--> [Payment Function]
```

## Requirements

- Node.js environment
- `socket.io-client` library
- Nodit API key
- Smart contract address and event signature details

## Implementation Steps

### 1. Smart Contract Event Identification

Before implementation, identify the specific event in your smart contract that should trigger the payment function:

- Event name (e.g., `Transfer`, `Payment`, `Purchase`)
- Event signature (e.g., `Transfer(address,address,uint256)`)
- Event parameters, especially those marked as `indexed`
- Keccak256 hash of the event signature (e.g., `0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef` for the Transfer event)

### 2. WebSocket Connection Setup

Create a WebSocket connection to Nodit's service with proper authentication:

- Endpoint: `wss://web3.nodit.io/v1/websocket`
- Authentication: Nodit API key
- Protocol & Network configuration

### 3. Event Subscription Configuration

Configure the subscription with:

- EventType: `LOG`
- Contract address
- Topics array (containing event signature hash and any indexed parameters you want to filter on)

### 4. Payment Functio   n Integration

Implement a handler that:

- Processes the incoming event data
- Validates the transaction details
- Triggers the payment function with appropriate parameters
- Implements error handling and retry mechanisms

## Technical Specifications

### WebSocket Connection Parameters

| Parameter | Description | Required | Example |
|-----------|-------------|----------|---------|
| URL | Nodit WebSocket endpoint | Yes | `wss://web3.nodit.io/v1/websocket` |
| apiKey | Authentication key from Nodit console | Yes | Your API key |
| protocol | Blockchain protocol | Yes | `ethereum`, `arbitrum`, etc. |
| network | Network name | Yes | `mainnet`, `testnet`, etc. |

### Event Subscription Parameters

| Parameter | Description | Required | Example |
|-----------|-------------|----------|---------|
| eventType | Type of event to monitor | Yes | `LOG` |
| address | Contract address | Yes | `0xdAC17F958D2ee523a2206206994597C13D831ec7` |
| topics | Array of event signature and indexed parameters | Yes | `["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef"]` |

### Event Data Structure

When an event is detected, Nodit will send a message with the following structure:

```json
{
  "subscriptionId": "string",
  "eventType": "LOG",
  "event": {
    "targetAddress": "string",
    "topics": [
      "string"
    ],
    "messages": [
      {
        "address": "string",
        "topics": [
          "string"
        ],
        "data": "string",
        "block_number": "number",
        "transaction_hash": "string",
        "transaction_index": "number",
        "log_index": "number",
        "block_hash": "string",
        "block_timestamp": "number",
        "removed": "boolean",
        "type": "string"
      }
    ]
  }
}
```

### Payment Function Interface

The payment function should accept parameters that include:

- Transaction identification (hash, block number)
- Event-specific data (parsed from the `data` field and `topics`)
- Amount/value information
- Sender and receiver addresses
- Timestamp

## Implementation Guidelines

### Setting up the WebSocket Client

The WebSocket client should be configured to:

1. Connect to Nodit's WebSocket service
2. Authenticate using your API key
3. Subscribe to the LOG event for your contract
4. Handle reconnection logic
5. Process incoming events

### Processing Event Data

When processing event data:

1. Decode the event data using the ABI encoding rules
2. Extract relevant payment information
3. Validate the event source and parameters
4. Call the payment function with extracted data
5. Implement idempotency to prevent duplicate processing

### Error Handling

Implement robust error handling:

1. Connection failures
2. Authentication errors
3. Subscription issues
4. Event processing errors
5. Payment function failures

### Logging and Monitoring

Implement comprehensive logging:

1. Connection events
2. Received events
3. Processing steps
4. Payment function calls
5. Errors and exceptions

## Security Considerations

- Store API keys securely
- Validate event source and parameters
- Implement rate limiting
- Monitor for unusual activity
- Implement transaction idempotency

## Testing Strategy

1. Use testnet environments before production
2. Create test smart contracts with known events
3. Simulate different event scenarios
4. Test reconnection handling
5. Test error scenarios
6. Validate payment function integration

## Deployment Considerations

- Environment configuration
- Service monitoring
- Restart policies
- Scaling approach
- Failover strategy

## Resources

- [Nodit API Documentation](https://web3.nodit.io/docs)
- [Socket.io Client Documentation](https://socket.io/docs/v4/client-api/)
- [Ethereum Event Log Format](https://ethereum.org/en/developers/docs/apis/json-rpc/#eth_getlogs)
